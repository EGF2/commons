"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}var axios=require("axios"),MonitoringClient=function(){function t(e){_classCallCheck(this,t),this._url=e.monitoring,this._serviceName=e.serviceName}return _createClass(t,[{key:"_getIPAddress",value:function(){var e=require("os").networkInterfaces();for(var t in e)for(var r=e[t],n=0;n<r.length;n++){var a=r[n];if("IPv4"===a.family&&"127.0.0.1"!==a.address&&!a.internal)return a.address}return"0.0.0.0"}},{key:"_getSalt",value:function(){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(axios.get("".concat(process.env.ECS_CONTAINER_METADATA_URI,"/task")));case 2:return t=e.sent,salt="".concat(t.data.Family,"|").concat(t.data.Containers[0].Name,"|").concat(t.data.TaskARN.split("/")[1]),e.abrupt("return",salt);case 5:case"end":return e.stop()}})}},{key:"pingMonitoring",value:function(t){var r;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._salt){e.next=4;break}return e.next=3,regeneratorRuntime.awrap(this._getSalt());case 3:this._salt=e.sent;case 4:return e.next=6,regeneratorRuntime.awrap(axios({method:"POST",url:"".concat(this._url,"/v2/internal/monitoring/status"),data:{service_type:this._serviceName,service_ip:this._getIPAddress(),status:t,salt:salt}}));case 6:return r=e.sent,e.abrupt("return",r);case 8:case"end":return e.stop()}},null,this)}},{key:"sendFailEvent",value:function(t){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(axios({method:"POST",url:"".concat(this._url,"/v2/internal/monitoring/send_error"),data:{service:this._serviceName,event:t}}));case 2:case"end":return e.stop()}},null,this)}}]),t}();module.exports.MonitoringClient=MonitoringClient;var salt="",getIPAddress=function(){var e=require("os").networkInterfaces();for(var t in e)for(var r=e[t],n=0;n<r.length;n++){var a=r[n];if("IPv4"===a.family&&"127.0.0.1"!==a.address&&!a.internal)return a.address}return"0.0.0.0"},pingMonitoring=function(s,i,o){return new Promise(function(t,r){var n,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,salt){e.next=12;break}return e.prev=2,e.next=5,regeneratorRuntime.awrap(axios.get("".concat(process.env.ECS_CONTAINER_METADATA_URI,"/task")));case 5:n=e.sent,salt="".concat(n.data.Family,"|").concat(n.data.Containers[0].Name,"|").concat(n.data.TaskARN.split("/")[1]),e.next=12;break;case 9:return e.prev=9,e.t0=e.catch(2),e.abrupt("return",t());case 12:return e.next=14,regeneratorRuntime.awrap(axios({method:"POST",url:s,data:{service_type:i,service_ip:getIPAddress(),status:o,salt:salt}}));case 14:a=e.sent,t(a),e.next=21;break;case 18:e.prev=18,e.t1=e.catch(0),r(e.t1);case 21:case"end":return e.stop()}},null,null,[[0,18],[2,9]])})};module.exports.pingMonitoring=pingMonitoring;